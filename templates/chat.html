<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRYPTAX | Ultra Nexus</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --p: #00f3ff; /* Neon Cyan */
            --s: #bc13fe; /* Neon Purple */
            --bg: #050508;
            --glass: rgba(10, 10, 20, 0.8);
            --border: rgba(0, 243, 255, 0.3);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; cursor: crosshair; }
        
        body { 
            font-family: 'JetBrains Mono', monospace; 
            background: var(--bg); 
            color: #fff; 
            height: 100dvh; 
            overflow: hidden;
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* Scanning Line Animation */
        body::after {
            content: "";
            position: absolute;
            top: -100%;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, transparent, rgba(0, 243, 255, 0.05), transparent);
            animation: scan 4s linear infinite;
            pointer-events: none;
        }
        @keyframes scan { 0% { top: -100%; } 100% { top: 100%; } }

        /* --- GLOBAL COMPONENTS --- */
        .overlay { 
            position: fixed; inset: 0; background: rgba(2, 2, 4, 0.95); 
            z-index: 2000; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; transition: 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }
        .hidden { opacity: 0; pointer-events: none; transform: scale(1.1); }

        .cyber-card {
            background: var(--glass);
            border: 1px solid var(--border);
            padding: 30px; width: 90%; max-width: 420px;
            position: relative; box-shadow: 0 0 30px rgba(0, 0, 0, 0.5), inset 0 0 15px rgba(0, 243, 255, 0.1);
            border-radius: 8px; text-align: center;
        }

        .cyber-card::before {
            content: ''; position: absolute; top: -2px; left: 50%; transform: translateX(-50%);
            width: 60%; height: 2px; background: var(--p); box-shadow: 0 0 10px var(--p);
        }

        h2, h1 { font-family: 'Orbitron'; letter-spacing: 4px; text-transform: uppercase; margin-bottom: 20px; }
        .glitch { color: var(--p); text-shadow: 2px 2px var(--s); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        input {
            width: 100%; padding: 15px; margin: 10px 0;
            background: rgba(0, 0, 0, 0.5); border: 1px solid #333;
            color: var(--p); font-family: 'Orbitron'; text-align: center;
            outline: none; transition: 0.3s; border-radius: 4px;
        }
        input:focus { border-color: var(--p); box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); }

        .btn {
            width: 100%; padding: 16px; background: transparent;
            color: var(--p); border: 1px solid var(--p); font-family: 'Orbitron';
            font-weight: 700; text-transform: uppercase; cursor: pointer;
            position: relative; overflow: hidden; transition: 0.3s;
            margin-top: 10px; border-radius: 4px;
        }
        .btn:hover { background: var(--p); color: #000; box-shadow: 0 0 25px var(--p); }

        /* --- CHAT AREA --- */
        #main-app { 
            display: none; height: 100%; flex-direction: column; 
            max-width: 600px; margin: 0 auto; background: rgba(5, 5, 10, 0.85); 
            border-left: 1px solid #222; border-right: 1px solid #222;
            backdrop-filter: blur(15px);
        }

        header {
            padding: 20px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0, 0, 0, 0.4);
        }

        #chat-feed { 
            flex: 1; overflow-y: auto; padding: 20px; 
            display: flex; flex-direction: column; gap: 18px;
            scroll-behavior: smooth;
        }

        /* Custom Scrollbar */
        #chat-feed::-webkit-scrollbar { width: 4px; }
        #chat-feed::-webkit-scrollbar-thumb { background: var(--p); }

        .bubble {
            max-width: 85%; padding: 15px; border-radius: 4px;
            position: relative; font-size: 0.95rem; line-height: 1.4;
            transition: 0.3s; background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .me { align-self: flex-end; border-right: 4px solid var(--s); text-align: right; }
        .them { align-self: flex-start; border-left: 4px solid var(--p); text-align: left; }
        
        .bubble.unlocked { 
            background: rgba(0, 243, 255, 0.05); 
            border-color: var(--p); color: #fff;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.1);
        }

        footer { 
            padding: 20px; display: flex; gap: 12px; 
            background: rgba(0, 0, 0, 0.6); border-top: 1px solid #222;
        }
        #msg-input { text-align: left; margin: 0; padding: 12px 20px; border-radius: 25px; }

        .sender-tag { font-size: 10px; color: var(--p); margin-bottom: 4px; display: block; opacity: 0.6; }
    </style>
</head>
<body>

    <audio id="snd-access" src="/static/cryptax_ringtone.mp3"></audio> 
    <audio id="snd-ui" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="snd-msg-send" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>
    <audio id="snd-msg-recv" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
    <audio id="snd-unlock" src="https://assets.mixkit.co/active_storage/sfx/2541/2541-preview.mp3"></audio>

    <div id="layer-access" class="overlay">
        <div class="cyber-card">
            <i class="fa-solid fa-shield-halved" style="font-size: 3rem; color: var(--p); margin-bottom: 15px;"></i>
            <h2 class="glitch">SECURE GATEWAY</h2>
            <input type="text" id="access-code" placeholder="ENTER ACCESS KEY">
            <button class="btn" onclick="verifyAccess()">AUTHORIZE</button>
        </div>
    </div>

    <div id="layer-anim" class="overlay hidden">
        <div class="cyber-card" style="border:none; background:none; box-shadow:none;">
            <h1 class="glitch" style="font-size: 2.5rem;">CRYPTAX</h1>
            <div style="width: 200px; height: 2px; background: #111; margin: 20px auto; position: relative; overflow: hidden;">
                <div style="position: absolute; width: 50%; height: 100%; background: var(--p); animation: load 2s infinite;"></div>
            </div>
            <p style="color: var(--p); font-size: 0.8rem; letter-spacing: 2px;">SYNCING NEURAL NODES...</p>
        </div>
    </div>
    <style>@keyframes load { 0% { left: -100%; } 100% { left: 100%; } }</style>

    <div id="layer-login" class="overlay hidden">
        <div class="cyber-card">
            <h2 style="color: var(--s);">NODE CONFIG</h2>
            <input type="text" id="node-id" placeholder="CRYPTA ID">
            <input type="text" id="user-name" placeholder="NAME">
            <button class="btn" style="border-color: var(--s); color: var(--s);" onclick="joinNode()">ESTABLISH LINK</button>
        </div>
    </div>

    <div id="layer-modal" class="overlay hidden">
        <div class="cyber-card">
            <h3 style="font-family:'Orbitron'; color: var(--p);">DECRYPT DATA</h3>
            <p style="font-size: 10px; margin-bottom: 10px; color: #555;">SECURITY CLEARANCE REQUIRED</p>
            <input type="password" id="modal-pass" maxlength="2" placeholder="**">
            <button class="btn" onclick="confirmDecrypt()">UNLOCK PACKET</button>
            <p onclick="closeModal()" style="color:#444; margin-top:20px; font-size:10px; cursor:pointer;">[ CANCEL_PROCESS ]</p>
        </div>
    </div>

    <div id="main-app">
        <header>
            <div style="font-family:'Orbitron'; font-size: 0.9rem;">
                <span style="color: var(--p);">‚óè</span> CRYPTAX_OS
            </div>
            <div id="display-node" style="color: var(--s); font-size: 0.7rem; font-weight: bold;"></div>
        </header>

        <main id="chat-feed"></main>

        <footer>
            <input type="text" id="msg-input" placeholder="Enter encrypted text..." autocomplete="off">
            <button class="btn" style="width: 60px; border-radius: 50%; margin: 0;" onclick="sendMessage()">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </footer>
    </div>

    <script>
        let roomID = "", senderName = "", selectedMsgElement = null, selectedMsgId = null, lastCount = 0;

        const playSnd = (id) => { const s = document.getElementById(id); s.currentTime = 0; s.play().catch(e=>{}); };

        function verifyAccess() {
            const code = document.getElementById('access-code').value;
            if (code.toLowerCase().startsWith("am")) {
                playSnd('snd-access'); 
                document.getElementById('layer-access').classList.add('hidden');
                document.getElementById('layer-anim').classList.remove('hidden');
                
                setTimeout(() => {
                    document.getElementById('layer-anim').classList.add('hidden');
                    document.getElementById('layer-login').classList.remove('hidden');
                }, 4500); 
            } else { 
                alert("ACCESS_DENIED: UNAUTHORIZED"); 
                playSnd('snd-ui');
            }
        }

        async function joinNode() {
            roomID = document.getElementById('node-id').value;
            senderName = document.getElementById('user-name').value;
            if (roomID && senderName) {
                playSnd('snd-ui');
                document.getElementById('display-node').innerText = "NODE_ID: " + roomID.toUpperCase();
                await fetch('/join', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ room_id: roomID, user_name: senderName }) 
                });
                document.getElementById('layer-login').classList.add('hidden');
                document.getElementById('main-app').style.display = 'flex';
                setInterval(fetchMessages, 2000);
            }
        }

        async function fetchMessages() {
            const res = await fetch('/fetch', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ room_id: roomID }) 
            });
            const data = await res.json();
            if (data.length > lastCount) {
                if(lastCount !== 0) playSnd('snd-msg-recv');
                const feed = document.getElementById('chat-feed');
                feed.innerHTML = '';
                data.forEach(msg => {
                    const isMe = msg.sender === senderName;
                    feed.innerHTML += `
                        <div class="bubble ${isMe ? 'me' : 'them'}" data-id="${msg.id}" data-cover="${msg.story}" data-status="locked" onclick="handleMsgClick(this)">
                            <span class="sender-tag">${msg.sender.toUpperCase()}</span>
                            <span class="txt">${msg.story}</span>
                        </div>`;
                });
                feed.scrollTop = feed.scrollHeight;
                lastCount = data.length;
            }
        }

        async function sendMessage() {
            const input = document.getElementById('msg-input');
            if (!input.value.trim()) return;
            playSnd('snd-msg-send');
            const text = input.value;
            input.value = '';
            await fetch('/send', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ room_id: roomID, message: text, sender_name: senderName }) 
            });
            fetchMessages();
        }

        function handleMsgClick(el) {
            if (el.getAttribute('data-status') === "locked") {
                selectedMsgElement = el; 
                selectedMsgId = el.getAttribute('data-id');
                document.getElementById('layer-modal').classList.remove('hidden');
            } else {
                el.querySelector('.txt').innerText = el.getAttribute('data-cover');
                el.setAttribute('data-status', 'locked'); 
                el.classList.remove('unlocked');
            }
        }

        async function confirmDecrypt() {
            const pass = document.getElementById('modal-pass').value;
            if (pass !== "11") {
                alert("DECRYPTION_FAILED");
                return;
            }
            const res = await fetch('/decrypt', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ room_id: roomID, msg_id: selectedMsgId, password: pass }) 
            });
            const data = await res.json();
            if (data.original) {
                playSnd('snd-unlock'); 
                closeModal();
                selectedMsgElement.querySelector('.txt').innerText = data.original;
                selectedMsgElement.setAttribute('data-status', 'unlocked'); 
                selectedMsgElement.classList.add('unlocked');
            }
        }

        function closeModal() { 
            document.getElementById('layer-modal').classList.add('hidden'); 
            document.getElementById('modal-pass').value = ''; 
        }

        document.getElementById('msg-input').addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') sendMessage(); 
        });
    </script>
</body>
</html>